<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø¨Ø±Ø§ Ø§Ù„Ø³Ø§Ù„ÙØ©</title>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="questions.js"></script>

<style>
body{
    font-family: sans-serif;
    background:#111;
    color:white;
    margin:0;
    text-align:center;
}
.container{
    padding:20px;
    max-width:500px;
    margin:auto;
}
input,button{
    padding:10px;
    margin:5px;
    width:90%;
    border:none;
    border-radius:6px;
}
button{
    background:#00b894;
    color:white;
    font-weight:bold;
}
.player{
    background:#222;
    margin:5px;
    padding:5px;
    border-radius:5px;
}
.hidden{display:none;}
.timer{
    font-size:20px;
    color:#ff7675;
}
</style>
</head>
<body>

<div class="container" id="home">
<h2>ğŸ­ Ø¨Ø±Ø§ Ø§Ù„Ø³Ø§Ù„ÙØ©</h2>
<input id="name" placeholder="Ø§Ø³Ù…Ùƒ">
<input id="room" placeholder="ÙƒÙˆØ¯ Ø§Ù„ØºØ±ÙØ©">
<button onclick="createRoom()">Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ©</button>
<button onclick="joinRoom()">Ø¯Ø®ÙˆÙ„ ØºØ±ÙØ©</button>
</div>

<div class="container hidden" id="lobby">
<h3>Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†</h3>
<div id="players"></div>
<button id="startBtn" onclick="startGame()">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨Ø©</button>
</div>

<div class="container hidden" id="game">
<h3 id="questionTitle"></h3>
<input id="answer" placeholder="Ø§ÙƒØªØ¨ Ø¥Ø¬Ø§Ø¨ØªÙƒ">
<button onclick="submitAnswer()">Ø¥Ø±Ø³Ø§Ù„</button>
</div>

<div class="container hidden" id="reveal">
<h3>Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ:</h3>
<h2 id="realQuestion"></h2>
<div class="timer" id="timer"></div>
<div id="votePlayers"></div>
</div>

<script>
var firebaseConfig = {
apiKey:"AIzaSyBgU2e3nrFc6k741ghQdB7UqqwNYaEvATk",
authDomain:"bra-alsalfa.firebaseapp.com",
databaseURL:"https://bra-alsalfa-default-rtdb.europe-west1.firebasedatabase.app"
};
firebase.initializeApp(firebaseConfig);
var db = firebase.database();

let playerName;
let roomCode;
let isMaster=false;
let myId = Math.random().toString(36).substr(2,9);

function createRoom(){
playerName=document.getElementById("name").value;
roomCode=document.getElementById("room").value;
if(!playerName||!roomCode) return alert("Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„ÙƒÙˆØ¯");

isMaster=true;

db.ref("rooms/"+roomCode).set({
master:myId,
state:"lobby",
players:{}
});

joinRoom();
}

function joinRoom(){
playerName=document.getElementById("name").value;
roomCode=document.getElementById("room").value;
if(!playerName||!roomCode) return alert("Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„ÙƒÙˆØ¯");

db.ref("rooms/"+roomCode+"/players/"+myId).set({
name:playerName,
score:0
});

listenRoom();
document.getElementById("home").classList.add("hidden");
document.getElementById("lobby").classList.remove("hidden");
}

function listenRoom(){
db.ref("rooms/"+roomCode).on("value",snap=>{
let data=snap.val();
if(!data)return;

let playersDiv=document.getElementById("players");
playersDiv.innerHTML="";
for(let id in data.players){
let p=data.players[id];
playersDiv.innerHTML+=`<div class="player">${p.name} - ${p.score}</div>`;
}

if(data.state==="game"){
document.getElementById("lobby").classList.add("hidden");
document.getElementById("game").classList.remove("hidden");

let q=data.questions[myId];
document.getElementById("questionTitle").innerText=q;
}

if(data.state==="reveal"){
showReveal(data);
}

if(data.state==="end"){
alert(data.winner+" ÙØ§Ø² ğŸ‰");
location.reload();
}
});
}

function startGame(){
let roomRef=db.ref("rooms/"+roomCode);
roomRef.once("value").then(snap=>{
let data=snap.val();
let ids=Object.keys(data.players);
if(ids.length<2||ids.length>5)return alert("2-5 Ù„Ø§Ø¹Ø¨ÙŠÙ†");

let imposter=ids[Math.floor(Math.random()*ids.length)];
let q=questions[Math.floor(Math.random()*questions.length)];

let questionMap={};
ids.forEach(id=>{
if(id===imposter){
questionMap[id]=q.fake;
}else{
questionMap[id]=q.real;
}
});

roomRef.update({
state:"game",
imposter:imposter,
questions:questionMap,
answers:{},
votes:{}
});
});
}

function submitAnswer(){
let val=document.getElementById("answer").value;
db.ref("rooms/"+roomCode+"/answers/"+myId).set(val);
document.getElementById("answer").disabled=true;

db.ref("rooms/"+roomCode+"/answers").once("value").then(snap=>{
if(Object.keys(snap.val()||{}).length>=2){
db.ref("rooms/"+roomCode).update({state:"reveal"});
}
});
}

function showReveal(data){
document.getElementById("game").classList.add("hidden");
document.getElementById("reveal").classList.remove("hidden");

document.getElementById("realQuestion").innerText=
questions.find(q=>q.real===data.questions[data.master]||true).real;

let voteDiv=document.getElementById("votePlayers");
voteDiv.innerHTML="";
for(let id in data.players){
voteDiv.innerHTML+=
`<button onclick="vote('${id}')">${data.players[id].name}</button>`;
}

startTimer();
}

function vote(id){
db.ref("rooms/"+roomCode+"/votes/"+myId).set(id);
}

function startTimer(){
let time=5;
let t=document.getElementById("timer");
let interval=setInterval(()=>{
t.innerText="Ø§Ù„ØªØµÙˆÙŠØª ÙŠÙ†ØªÙ‡ÙŠ Ø¨Ø¹Ø¯ "+time+" Ø«";
time--;
if(time<0){
clearInterval(interval);
finishRound();
}
},1000);
}

function finishRound(){
db.ref("rooms/"+roomCode).once("value").then(snap=>{
let data=snap.val();
let votes=data.votes||{};
let count={};
for(let v in votes){
let target=votes[v];
count[target]=(count[target]||0)+1;
}
let max=0;
let accused=null;
for(let id in count){
if(count[id]>max){
max=count[id];
accused=id;
}
}
let imposter=data.imposter;

if(accused===imposter){
for(let v in votes){
if(votes[v]===imposter){
db.ref("rooms/"+roomCode+"/players/"+v+"/score")
.transaction(s=> (s||0)+1);
}
}
db.ref("rooms/"+roomCode+"/players/"+imposter+"/score")
.transaction(s=> (s||0)-1);
}else{
db.ref("rooms/"+roomCode+"/players/"+imposter+"/score")
.transaction(s=> (s||0)+1);
}

checkWinner();
});
}

function checkWinner(){
db.ref("rooms/"+roomCode+"/players").once("value").then(snap=>{
let players=snap.val();
for(let id in players){
if(players[id].score>=5){
db.ref("rooms/"+roomCode).update({
state:"end",
winner:players[id].name
});
}
}
db.ref("rooms/"+roomCode).update({state:"lobby"});
});
}
</script>
</body>
</html>
