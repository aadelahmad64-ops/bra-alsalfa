<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø¨Ø±Ø§ Ø§Ù„Ø³Ø§Ù„ÙØ©</title>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="questions.js"></script>

<style>
body{
margin:0;
font-family:sans-serif;
background:radial-gradient(circle,#1a1a2e,#0f0c29);
color:white;
display:flex;
justify-content:center;
align-items:center;
min-height:100vh;
}
.container{
background:rgba(255,255,255,0.07);
backdrop-filter:blur(10px);
padding:20px;
border-radius:20px;
width:95%;
max-width:500px;
box-shadow:0 0 30px rgba(0,0,0,0.7);
}
input,button{
width:100%;
padding:12px;
margin:6px 0;
border:none;
border-radius:10px;
font-size:16px;
}
button{
background:linear-gradient(45deg,#667eea,#764ba2);
color:white;
font-weight:bold;
}
button:hover{opacity:0.9}
.card{
background:rgba(255,255,255,0.1);
padding:10px;
border-radius:10px;
margin:5px 0;
}
.host{border:2px solid gold}
.vote.selected{background:#ff4d6d}
.question{text-align:center;margin:15px 0;font-size:18px}
</style>
</head>
<body>

<div class="container" id="app"></div>

<script>

var firebaseConfig={
apiKey:"AIzaSyBgU2e3nrFc6k741ghQdB7UqqwNYaEvATk",
authDomain:"bra-alsalfa.firebaseapp.com",
databaseURL:"https://bra-alsalfa-default-rtdb.europe-west1.firebasedatabase.app"
};

firebase.initializeApp(firebaseConfig);
var db=firebase.database();

let gameCode=null;
let playerId=null;
let playerName=null;
let gameData=null;

function rand(){return Math.random().toString(36).substr(2,9)}

function renderHome(){
document.getElementById("app").innerHTML=`
<h2>ğŸ­ Ø¨Ø±Ø§ Ø§Ù„Ø³Ø§Ù„ÙØ©</h2>
<input id="name" placeholder="Ø§Ø³Ù…Ùƒ">
<input id="code" placeholder="ÙƒÙˆØ¯ Ø§Ù„ØºØ±ÙØ©">
<button onclick="createRoom()">Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ©</button>
<button onclick="joinRoom()">Ø¯Ø®ÙˆÙ„ ØºØ±ÙØ©</button>
`;
}

function listen(){
firebase.database().ref("games/"+gameCode).on("value",snap=>{
gameData=snap.val();
if(!gameData){ renderHome(); return; }
renderGame();
});
}

function createRoom(){
playerName=document.getElementById("name").value.trim();
if(!playerName)return alert("Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ");

gameCode=Math.floor(1000+Math.random()*9000).toString();
playerId=rand();

firebase.database().ref("games/"+gameCode).set({
status:"waiting",
round:0,
players:{
[playerId]:{name:playerName,score:0,isHost:true}
}
});

listen();
}

function joinRoom(){
playerName=document.getElementById("name").value.trim();
gameCode=document.getElementById("code").value.trim();
if(!playerName||!gameCode)return alert("Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„ÙƒÙˆØ¯");

playerId=rand();

firebase.database().ref("games/"+gameCode+"/players/"+playerId).set({
name:playerName,score:0,isHost:false
});

listen();
}

function isHost(){
return gameData.players[playerId]?.isHost;
}

function startGame(){
if(!isHost())return;

let ids=Object.keys(gameData.players);
if(ids.length<2||ids.length>5)return alert("2-5 Ù„Ø§Ø¹Ø¨ÙŠÙ†");

let imp=ids[Math.floor(Math.random()*ids.length)];
let q=QUESTIONS[Math.floor(Math.random()*QUESTIONS.length)];

firebase.database().ref("games/"+gameCode).update({
status:"writing",
imposterId:imp,
normalQuestion:q.normal,
imposterQuestion:q.imposter,
answers:{},
votes:{}
});
}

function submitAnswer(){
let val=document.getElementById("answer").value.trim();
if(!val)return;
firebase.database().ref("games/"+gameCode+"/answers/"+playerId).set(val);
}

function startVoting(){
if(!isHost())return;
firebase.database().ref("games/"+gameCode).update({status:"voting"});
startTimer();
}

function vote(id){
if(gameData.votes?.[playerId])return;
firebase.database().ref("games/"+gameCode+"/votes/"+playerId).set(id);
}

function startTimer(){
let t=5;
let int=setInterval(()=>{
let el=document.getElementById("timer");
if(el)el.innerText=t;
t--;
if(t<0){clearInterval(int);finishRound();}
},1000);
}

function finishRound(){
if(!isHost())return;

let votes=gameData.votes||{};
let count={};
for(let v in votes){
count[votes[v]]=(count[votes[v]]||0)+1;
}

let accused=null,max=0;
for(let id in count){
if(count[id]>max){max=count[id];accused=id;}
}

let imp=gameData.imposterId;
let updates={};

if(accused===imp){
for(let v in votes){
if(votes[v]===imp){
let s=gameData.players[v].score||0;
updates["games/"+gameCode+"/players/"+v+"/score"]=s+1;
}
}
let s=gameData.players[imp].score||0;
updates["games/"+gameCode+"/players/"+imp+"/score"]=s-1;
}else{
let s=gameData.players[imp].score||0;
updates["games/"+gameCode+"/players/"+imp+"/score"]=s+1;
}

updates["games/"+gameCode+"/status"]="result";
updates["games/"+gameCode+"/lastVotes"]=votes;

firebase.database().ref().update(updates);
}

function nextRound(){
if(!isHost())return;
firebase.database().ref("games/"+gameCode).update({status:"waiting"});
}

function renderGame(){

let playersHTML="";
for(let id in gameData.players){
let p=gameData.players[id];
playersHTML+=`
<div class="card ${p.isHost?'host':''}">
${p.name} (${p.score})
${p.isHost?"ğŸ‘‘":""}
</div>`;
}

let content="";

switch(gameData.status){

case "waiting":
content=isHost()?`<button onclick="startGame()">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¬ÙˆÙ„Ø©</button>`:"Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ø§Ø³ØªØ±";
break;

case "writing":
let q=(playerId===gameData.imposterId)?
gameData.imposterQuestion:
gameData.normalQuestion;

content=`
<div class="question">${q}</div>
<input id="answer" placeholder="Ø§ÙƒØªØ¨ Ø¥Ø¬Ø§Ø¨ØªÙƒ">
<button onclick="submitAnswer()">Ø¥Ø±Ø³Ø§Ù„</button>
${isHost()?'<button onclick="startVoting()">Ø¨Ø¯Ø¡ Ø§Ù„ØªØµÙˆÙŠØª</button>':""}
`;
break;

case "voting":
let btns="";
for(let id in gameData.players){
if(id!==playerId){
btns+=`<button class="vote ${gameData.votes?.[playerId]===id?'selected':''}" onclick="vote('${id}')">${gameData.players[id].name}</button>`;
}
}
content=`
<div>Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ: ${gameData.normalQuestion}</div>
<div id="timer">5</div>
${btns}
`;
break;

case "result":
let votes=gameData.lastVotes||{};
let breakdown="";
for(let v in votes){
breakdown+=`${gameData.players[v].name} âœ ${gameData.players[votes[v]].name}<br>`;
}
content=`
<div>Ø¨Ø±Ø§ Ø§Ù„Ø³Ø§Ù„ÙØ©: ${gameData.players[gameData.imposterId].name}</div>
<div>${breakdown}</div>
${isHost()?'<button onclick="nextRound()">Ø¬ÙˆÙ„Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>':""}
`;
break;
}

document.getElementById("app").innerHTML=`
<h2>ğŸ­ Ø¨Ø±Ø§ Ø§Ù„Ø³Ø§Ù„ÙØ© | ${gameCode}</h2>
${playersHTML}
${content}
`;
}

renderHome();

</script>

</body>
</html>
