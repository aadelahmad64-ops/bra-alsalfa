<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø¨Ø±Ø§ Ø§Ù„Ø³Ø§Ù„ÙØ©</title>

<script type="module">

import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
import { getDatabase, ref, set, update, onValue, get } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js';
import './questions.js';

const firebaseConfig = {
apiKey: "AIzaSyBgU2e3nrFc6k741ghQdB7UqqwNYaEvATk",
authDomain: "bra-alsalfa.firebaseapp.com",
databaseURL: "https://bra-alsalfa-default-rtdb.europe-west1.firebasedatabase.app"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let gameCode=null;
let playerId=null;
let playerName=null;
let gameData=null;

function randId(){ return Math.random().toString(36).slice(2,9); }

window.createRoom = async function(){
playerName=document.getElementById("name").value.trim();
if(!playerName)return alert("Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ");

gameCode=Math.floor(1000+Math.random()*9000).toString();
playerId=randId();

await set(ref(db,"games/"+gameCode),{
status:"waiting",
round:0,
players:{
[playerId]:{name:playerName,score:0,isHost:true}
}
});

listen();
}

window.joinRoom = async function(){
playerName=document.getElementById("name").value.trim();
gameCode=document.getElementById("code").value.trim();
if(!playerName||!gameCode)return alert("Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„ÙƒÙˆØ¯");

playerId=randId();

await update(ref(db,"games/"+gameCode+"/players"),{
[playerId]:{name:playerName,score:0,isHost:false}
});

listen();
}

function listen(){
onValue(ref(db,"games/"+gameCode),snap=>{
gameData=snap.val();
render();
});
}

window.startGame = async function(){
if(!isHost())return;

let ids=Object.keys(gameData.players);
if(ids.length<2||ids.length>5)return alert("2-5 Ù„Ø§Ø¹Ø¨ÙŠÙ†");

let imposter=ids[Math.floor(Math.random()*ids.length)];
let q=QUESTIONS[Math.floor(Math.random()*QUESTIONS.length)];

await update(ref(db,"games/"+gameCode),{
status:"writing",
round:gameData.round+1,
imposterId:imposter,
normalQuestion:q.normal,
imposterQuestion:q.imposter,
answers:{},
votes:{}
});
}

window.submitAnswer = async function(){
let val=document.getElementById("answer").value.trim();
if(!val)return;
await update(ref(db,"games/"+gameCode+"/answers"),{
[playerId]:val
});
}

window.startVoting = async function(){
if(!isHost())return;
await update(ref(db,"games/"+gameCode),{status:"voting"});
startTimer();
}

window.vote = async function(id){
if(gameData.votes?.[playerId])return;
await update(ref(db,"games/"+gameCode+"/votes"),{
[playerId]:id
});
}

function startTimer(){
let t=5;
let int=setInterval(()=>{
document.getElementById("timer").innerText=t;
t--;
if(t<0){
clearInterval(int);
finishRound();
}
},1000);
}

async function finishRound(){
if(!isHost())return;

let votes=gameData.votes||{};
let count={};
Object.values(votes).forEach(v=>{
count[v]=(count[v]||0)+1;
});

let accused=Object.keys(count).reduce((a,b)=>count[a]>count[b]?a:b);
let imposter=gameData.imposterId;
let updates={};

if(accused===imposter){
for(let v in votes){
if(votes[v]===imposter){
updates[`games/${gameCode}/players/${v}/score`]=(gameData.players[v].score||0)+1;
}
}
updates[`games/${gameCode}/players/${imposter}/score`]=(gameData.players[imposter].score||0)-1;
}else{
updates[`games/${gameCode}/players/${imposter}/score`]=(gameData.players[imposter].score||0)+1;
}

updates[`games/${gameCode}/status`]="result";
updates[`games/${gameCode}/lastVotes`]=votes;

await update(ref(db),updates);
}

window.nextRound = async function(){
if(!isHost())return;
await update(ref(db,"games/"+gameCode),{status:"waiting"});
}

function isHost(){
return gameData.players[playerId]?.isHost;
}

function render(){

if(!gameData){
document.body.innerHTML=home();
return;
}

let players=Object.entries(gameData.players).map(([id,p])=>`
<div class="card ${p.isHost?'host':''}">
${p.name} (${p.score})
${p.isHost?"ğŸ‘‘":""}
${isHost()&&!p.isHost?`<button onclick="kick('${id}')">Ø·Ø±Ø¯</button>`:""}
</div>`).join("");

let content="";

switch(gameData.status){

case "waiting":
content=`<button onclick="startGame()">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¬ÙˆÙ„Ø©</button>`;
break;

case "writing":
let q=playerId===gameData.imposterId?
gameData.imposterQuestion:
gameData.normalQuestion;

content=`
<div class="question">${q}</div>
<input id="answer" placeholder="Ø§ÙƒØªØ¨ Ø¥Ø¬Ø§Ø¨ØªÙƒ">
<button onclick="submitAnswer()">Ø¥Ø±Ø³Ø§Ù„</button>
${isHost()?'<button onclick="startVoting()">Ø¨Ø¯Ø¡ Ø§Ù„ØªØµÙˆÙŠØª</button>':""}
`;
break;

case "voting":
let voteBtns=Object.entries(gameData.players)
.filter(([id])=>id!==playerId)
.map(([id,p])=>
`<button class="vote ${gameData.votes?.[playerId]===id?'selected':''}"
onclick="vote('${id}')">${p.name}</button>`).join("");

content=`
<div>Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ: ${gameData.normalQuestion}</div>
<div id="timer">5</div>
${voteBtns}
`;
break;

case "result":
let votes=gameData.lastVotes||{};
let breakdown=Object.entries(votes)
.map(([v,t])=>`${gameData.players[v].name} âœ ${gameData.players[t].name}`)
.join("<br>");

content=`
<div>Ø¨Ø±Ø§ Ø§Ù„Ø³Ø§Ù„ÙØ©: ${gameData.players[gameData.imposterId].name}</div>
<div>${breakdown}</div>
${isHost()?'<button onclick="nextRound()">Ø¬ÙˆÙ„Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>':""}
`;
break;
}

document.body.innerHTML=`
<div class="container">
<h2>ğŸ­ Ø¨Ø±Ø§ Ø§Ù„Ø³Ø§Ù„ÙØ© | ${gameCode}</h2>
<div class="players">${players}</div>
${content}
</div>`;
}

function home(){
return `
<div class="container">
<h2>ğŸ­ Ø¨Ø±Ø§ Ø§Ù„Ø³Ø§Ù„ÙØ©</h2>
<input id="name" placeholder="Ø§Ø³Ù…Ùƒ">
<input id="code" placeholder="ÙƒÙˆØ¯ Ø§Ù„ØºØ±ÙØ©">
<button onclick="createRoom()">Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ©</button>
<button onclick="joinRoom()">Ø¯Ø®ÙˆÙ„ ØºØ±ÙØ©</button>
</div>`;
}

window.kick=async function(id){
if(!isHost())return;
await update(ref(db,"games/"+gameCode+"/players"),{
[id]:null
});
}

</script>

<style>
body{
margin:0;
font-family:sans-serif;
background:radial-gradient(circle,#141e30,#0f0c29);
color:white;
display:flex;
justify-content:center;
align-items:center;
height:100vh;
}
.container{
background:rgba(255,255,255,0.05);
backdrop-filter:blur(15px);
padding:20px;
border-radius:20px;
width:95%;
max-width:500px;
box-shadow:0 0 30px rgba(0,0,0,0.6);
}
input,button{
width:100%;
padding:12px;
margin:6px 0;
border:none;
border-radius:10px;
font-size:16px;
}
button{
background:linear-gradient(45deg,#667eea,#764ba2);
color:white;
font-weight:bold;
}
button:hover{
opacity:0.9;
}
.card{
background:rgba(255,255,255,0.1);
padding:10px;
border-radius:10px;
margin:5px 0;
}
.host{
border:2px solid gold;
}
.vote.selected{
background:#ff4d6d;
}
.question{
font-size:18px;
margin:15px 0;
text-align:center;
}
</style>

</head>
<body></body>
</html>
