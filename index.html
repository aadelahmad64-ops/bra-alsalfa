<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¨Ø±Ø§ Ø§Ù„Ø³Ø§Ù„ÙØ© - Ù„Ø¹Ø¨Ø© Ø§Ù„ÙƒØ°Ø¨</title>
    <style>
        /* Ù†ÙØ³ Ø§Ù„ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© Ù…Ø¹ Ø¥Ø¶Ø§ÙØ© ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px;
        }

        .container {
            background: white;
            border-radius: 20px;
            padding: 20px;
            width: 100%;
            max-width: 900px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }

        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
            flex-wrap: wrap;
            gap: 10px;
        }

        .game-info {
            display: flex;
            gap: 15px;
            color: #666;
            flex-wrap: wrap;
        }

        h1 {
            color: #667eea;
            font-size: 1.8em;
        }

        input, button {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s;
        }

        input:focus {
            outline: none;
            border-color: #667eea;
        }

        button {
            background: #667eea;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
            transition: transform 0.2s;
        }

        button:hover {
            background: #5a67d8;
            transform: translateY(-2px);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .exit-btn {
            background: #ff6b6b;
            width: auto;
            padding: 8px 15px;
            font-size: 0.9em;
        }

        .exit-btn:hover {
            background: #ff5252;
        }

        .join-section, .create-section {
            margin: 20px 0;
            padding: 20px;
            border-radius: 10px;
            background: #f8f9fa;
        }

        .players-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin: 20px 0;
            max-height: 250px;
            overflow-y: auto;
            padding: 5px;
        }

        .player-card {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 10px;
            text-align: center;
            border: 2px solid transparent;
            position: relative;
        }

        .player-card.host {
            border-color: #ffd700;
            background: #fff9e6;
        }

        .player-card .player-name {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
            font-size: 1.1em;
        }

        .player-card .score {
            color: #667eea;
            font-weight: bold;
            font-size: 1.1em;
        }

        .player-card .you-badge {
            background: #667eea;
            color: white;
            padding: 2px 8px;
            border-radius: 15px;
            font-size: 0.8em;
            display: inline-block;
            margin-top: 5px;
        }

        .disconnected-badge {
            background: #ff6b6b;
            color: white;
            padding: 2px 8px;
            border-radius: 15px;
            font-size: 0.8em;
            display: inline-block;
            margin-top: 5px;
        }

        .screen {
            display: none;
        }

        .screen.active {
            display: block;
        }

        .hidden {
            display: none !important;
        }

        .question-box {
            background: #667eea;
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
        }

        .question-box h3 {
            margin-bottom: 10px;
            font-size: 1.1em;
            opacity: 0.9;
        }

        .question-box p {
            font-size: 1.4em;
            font-weight: bold;
        }

        .answer-input {
            margin: 20px 0;
        }

        .answers-status {
            text-align: center;
            color: #666;
            font-size: 1.1em;
            margin: 10px 0;
        }

        .reveal-section {
            text-align: center;
            margin: 20px 0;
        }

        #revealQuestionBtn {
            background: #ff6b6b;
            width: auto;
            padding: 15px 30px;
            font-size: 1.2em;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .answers-display {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 15px;
            margin: 20px 0;
            max-height: 300px;
            overflow-y: auto;
            padding: 5px;
        }

        .answer-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border: 2px solid #e0e0e0;
        }

        .answer-card .player-name {
            font-weight: bold;
            color: #667eea;
            margin-bottom: 8px;
            font-size: 1.1em;
        }

        .answer-card .answer-text {
            font-size: 1.1em;
            color: #333;
            word-break: break-word;
        }

        .voting-section {
            text-align: center;
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        #votingTimer {
            font-size: 4em;
            color: #ff6b6b;
            margin: 20px 0;
            font-weight: bold;
        }

        #votingButtons {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 20px;
        }

        .vote-btn {
            background: #e0e0e0;
            color: #333;
        }

        .vote-btn:hover:not(:disabled) {
            background: #ff6b6b;
            color: white;
        }

        .result-content {
            text-align: center;
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .imposter-reveal {
            background: #ff6b6b;
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin: 15px 0;
        }

        .winner-reveal {
            background: #48bb78;
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin: 15px 0;
        }

        .game-winner {
            background: #ffd700;
            color: #333;
            padding: 25px;
            border-radius: 15px;
            margin: 20px 0;
            font-size: 1.3em;
        }

        #nextRoundBtn {
            width: auto;
            margin: 20px auto;
            display: block;
            padding: 15px 40px;
            font-size: 1.2em;
        }

        .copy-btn {
            background: #48bb78;
            padding: 8px 15px;
            font-size: 0.9em;
            width: auto;
            margin-right: 10px;
        }

        .link-box {
            display: flex;
            gap: 10px;
            align-items: center;
            background: #f0f0f0;
            padding: 10px;
            border-radius: 10px;
            margin: 10px 0;
        }

        .link-box input {
            margin: 0;
            flex: 1;
            background: white;
        }

        .loading-screen {
            text-align: center;
            padding: 50px;
        }

        .loading-screen .spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background: #ff6b6b;
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            text-align: center;
        }

        .header-buttons {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        @media (max-width: 600px) {
            .container {
                padding: 15px;
            }
            
            .game-header {
                flex-direction: column;
                text-align: center;
            }
            
            h1 {
                font-size: 1.5em;
            }
            
            .question-box p {
                font-size: 1.2em;
            }

            .header-buttons {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container" id="app">
        <div class="loading-screen">
            <h2>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù„Ø¹Ø¨Ø©...</h2>
            <div class="spinner"></div>
        </div>
    </div>

    <script type="module">
        // Ø§Ø³ØªÙŠØ±Ø§Ø¯ Firebase Ù…Ø¨Ø§Ø´Ø±Ø© Ù…Ù† CDN
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
        import { getDatabase, ref, set, onValue, update, get, remove } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js';

        // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBgU2e3nrFc6k741ghQdB7UqqwNYaEvATk",
            authDomain: "bra-alsalfa.firebaseapp.com",
            databaseURL: "https://bra-alsalfa-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "bra-alsalfa",
            storageBucket: "bra-alsalfa.firebasestorage.app",
            messagingSenderId: "883405066643",
            appId: "1:883405066643:web:13dffce9c91df1aea69866"
        };

        // Initialize Firebase
        let app, database;
        try {
            app = initializeApp(firebaseConfig);
            database = getDatabase(app);
            console.log('âœ… Firebase connected successfully');
        } catch (error) {
            console.error('âŒ Firebase connection error:', error);
        }

        // Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù„Ø¹Ø¨Ø©
        let playerId = null;
        let gameCode = null;
        let playerName = '';
        let gameData = null;
        let timerInterval = null;
        let gameRef = null;
        let presenceInterval = null;

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ ÙƒÙˆØ¯ ÙÙŠ Ø§Ù„Ø±Ø§Ø¨Ø·
        const urlParams = new URLSearchParams(window.location.search);
        const joinCode = urlParams.get('join');
        
        // Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø®Ø²Ù†Ø©
        try {
            const savedData = localStorage.getItem('bra-alsalfa');
            if (savedData) {
                const parsed = JSON.parse(savedData);
                playerId = parsed.playerId;
                gameCode = parsed.gameCode;
                playerName = parsed.playerName;
            }
        } catch (e) {
            console.log('No saved data');
        }

        // Ø¯Ø§Ù„Ø© Ù„Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        function saveGameData() {
            localStorage.setItem('bra-alsalfa', JSON.stringify({
                playerId,
                gameCode,
                playerName
            }));
        }

        // Ø¯Ø§Ù„Ø© Ù„Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        function clearGameData() {
            localStorage.removeItem('bra-alsalfa');
            playerId = null;
            gameCode = null;
            playerName = '';
        }

        // Ø¯Ø§Ù„Ø© Ù„Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† Ø§Ù„Ù„Ø¹Ø¨Ø©
        window.leaveGame = async function() {
            if (!gameCode || !playerId || !gameData) return;
            
            try {
                // Ø­Ø°Ù Ø§Ù„Ù„Ø§Ø¹Ø¨ Ù…Ù† Ø§Ù„Ù„Ø¹Ø¨Ø©
                const playerRef = ref(database, `games/${gameCode}/players/${playerId}`);
                await remove(playerRef);
                
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ø¯ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø§Ù„Ù…ØªØ¨Ù‚ÙŠÙ†
                const remainingPlayers = Object.keys(gameData.players || {}).filter(id => id !== playerId).length;
                
                if (remainingPlayers === 0) {
                    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø¢Ø®Ø± Ù„Ø§Ø¹Ø¨ØŒ Ø§Ø­Ø°Ù Ø§Ù„ØºØ±ÙØ© ÙƒÙ„Ù‡Ø§
                    await remove(ref(database, `games/${gameCode}`));
                } else if (gameData.players[playerId]?.isHost) {
                    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø¶ÙŠÙ Ù‡Ùˆ Ø§Ù„Ù„ÙŠ Ø·Ø§Ù„Ø¹ØŒ Ø®Ù„ÙŠ Ø£ÙˆÙ„ Ù„Ø§Ø¹Ø¨ ÙŠØµÙŠØ± Ù…Ø¶ÙŠÙ
                    const firstPlayer = Object.keys(gameData.players).find(id => id !== playerId);
                    if (firstPlayer) {
                        const updates = {};
                        updates[`games/${gameCode}/players/${firstPlayer}/isHost`] = true;
                        await update(ref(database), updates);
                    }
                }
                
                // Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
                clearGameData();
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
                renderApp();
                
            } catch (error) {
                console.error('Error leaving game:', error);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† Ø§Ù„Ù„Ø¹Ø¨Ø©');
            }
        };

        // Ø¯Ø§Ù„Ø© Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† ÙˆØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…Ù†Ù‚Ø·Ø¹ÙŠÙ†
        function setupPresence() {
            if (!gameCode || !playerId) return;
            
            // ØªØ­Ø¯ÙŠØ« Ø¢Ø®Ø± Ø¸Ù‡ÙˆØ± ÙƒÙ„ 10 Ø«ÙˆØ§Ù†ÙŠ
            if (presenceInterval) clearInterval(presenceInterval);
            
            presenceInterval = setInterval(async () => {
                try {
                    const lastSeenRef = ref(database, `games/${gameCode}/players/${playerId}/lastSeen`);
                    await set(lastSeenRef, Date.now());
                } catch (error) {
                    console.error('Error updating presence:', error);
                }
            }, 10000);
        }

        // Ø¯Ø§Ù„Ø© Ù„ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø§Ù„Ù…Ù†Ù‚Ø·Ø¹ÙŠÙ† (Ø¢Ø®Ø± Ø¸Ù‡ÙˆØ± Ù…Ù† Ø£ÙƒØ«Ø± Ù…Ù† Ø¯Ù‚ÙŠÙ‚Ø©)
        async function cleanupDisconnectedPlayers() {
            if (!gameData || !gameCode) return;
            
            const now = Date.now();
            const updates = {};
            
            for (let id in gameData.players) {
                const lastSeen = gameData.players[id]?.lastSeen || 0;
                // Ø¥Ø°Ø§ Ø¢Ø®Ø± Ø¸Ù‡ÙˆØ± Ù…Ù† Ø£ÙƒØ«Ø± Ù…Ù† Ø¯Ù‚ÙŠÙ‚Ø© (60000 Ù…Ù„ÙŠ Ø«Ø§Ù†ÙŠØ©)
                if (now - lastSeen > 60000) {
                    console.log(`Cleaning up disconnected player: ${gameData.players[id]?.name}`);
                    updates[`games/${gameCode}/players/${id}`] = null;
                }
            }
            
            if (Object.keys(updates).length > 0) {
                await update(ref(database), updates);
            }
        }

        // Ø¯Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©
        async function renderApp() {
            const appDiv = document.getElementById('app');
            
            if (!playerId || !gameCode) {
                renderJoinScreen(appDiv);
            } else {
                // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù„Ø¹Ø¨Ø©
                try {
                    gameRef = ref(database, 'games/' + gameCode);
                    
                    // Ø§Ø³ØªØ®Ø¯Ø§Ù… onValue Ù…Ø¹ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
                    onValue(gameRef, async (snapshot) => {
                        if (snapshot.exists()) {
                            gameData = snapshot.val();
                            
                            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù„Ø§Ø¹Ø¨ ÙÙŠ Ø§Ù„Ù„Ø¹Ø¨Ø©
                            if (!gameData.players || !gameData.players[playerId]) {
                                console.log('Player not found in game, clearing data');
                                clearGameData();
                                renderJoinScreen(appDiv);
                                return;
                            }
                            
                            // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø§Ù„Ù…Ù†Ù‚Ø·Ø¹ÙŠÙ†
                            await cleanupDisconnectedPlayers();
                            
                            // ØªØ­Ø¯ÙŠØ« Ø¢Ø®Ø± Ø¸Ù‡ÙˆØ±
                            const lastSeenRef = ref(database, `games/${gameCode}/players/${playerId}/lastSeen`);
                            await set(lastSeenRef, Date.now());
                            
                            console.log('ğŸ“¦ Game data updated:', gameData);
                            renderGameScreen(appDiv);
                            
                            if (gameData?.status === 'voting') {
                                startVotingTimer();
                            }
                            
                            // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªÙˆØ§Ø¬Ø¯
                            setupPresence();
                        } else {
                            // Ø§Ù„Ù„Ø¹Ø¨Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©
                            showError('Ø§Ù„Ù„Ø¹Ø¨Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©', appDiv);
                            clearGameData();
                        }
                    }, (error) => {
                        console.error('Firebase error:', error);
                        showError('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„: ' + error.message, appDiv);
                    });
                    
                } catch (error) {
                    console.error('Error loading game:', error);
                    showError('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù„Ø¹Ø¨Ø©', appDiv);
                }
            }
        }

        function showError(message, container) {
            container.innerHTML = `
                <div class="error-message">
                    <h3>âŒ Ø®Ø·Ø£</h3>
                    <p>${message}</p>
                    <button onclick="window.location.reload()">Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„</button>
                    <button onclick="window.clearGameData(); window.location.reload()">Ø±Ø¬ÙˆØ¹ Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
                </div>
            `;
        }

        // Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„
        function renderJoinScreen(container) {
            container.innerHTML = `
                <div class="game-header">
                    <h1>ğŸ® Ø¨Ø±Ø§ Ø§Ù„Ø³Ø§Ù„ÙØ©</h1>
                </div>
                
                <div class="join-section">
                    <h2>ğŸ”‘ Ø§Ù†Ø¶Ù… Ù„Ù„Ø¹Ø¨Ø©</h2>
                    <input type="text" id="playerName" placeholder="Ø§Ø³Ù…Ùƒ" maxlength="20" value="${playerName || ''}">
                    <input type="text" id="gameCode" placeholder="ÙƒÙˆØ¯ Ø§Ù„ØºØ±ÙØ© (Ù…Ø«Ø§Ù„: 1234)" value="${joinCode || ''}">
                    <button onclick="window.joinGame()">Ø§Ù†Ø¶Ù… Ù„Ù„Ø¹Ø¨Ø©</button>
                </div>

                <div class="create-section">
                    <h2>ğŸ² Ø£Ùˆ Ø§ØµÙ†Ø¹ ØºØ±ÙØ© Ø¬Ø¯ÙŠØ¯Ø©</h2>
                    <button onclick="window.createGame()">Ø§ØµÙ†Ø¹ ØºØ±ÙØ© Ø¬Ø¯ÙŠØ¯Ø©</button>
                </div>
            `;
        }

        // Ø´Ø§Ø´Ø© Ø§Ù„Ù„Ø¹Ø¨Ø©
        function renderGameScreen(container) {
            if (!gameData) {
                container.innerHTML = `
                    <div class="loading-screen">
                        <h2>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù„Ø¹Ø¨Ø©...</h2>
                        <div class="spinner"></div>
                    </div>
                `;
                return;
            }

            const players = gameData.players || {};
            const playersCount = Object.keys(players).length;
            const currentPlayer = players[playerId];
            
            if (!currentPlayer) {
                // Ø§Ù„Ù„Ø§Ø¹Ø¨ Ù„ÙŠØ³ ÙÙŠ Ø§Ù„Ù„Ø¹Ø¨Ø©
                clearGameData();
                renderJoinScreen(container);
                return;
            }

            const isHost = currentPlayer?.isHost || false;

            // Ø§Ù„Ù‡ÙŠØ¯Ø± Ø§Ù„Ø«Ø§Ø¨Øª Ù…Ø¹ Ø²Ø± Ø§Ù„Ø®Ø±ÙˆØ¬
            const header = `
                <div class="game-header">
                    <h1>ğŸ® Ø¨Ø±Ø§ Ø§Ù„Ø³Ø§Ù„ÙØ©</h1>
                    <div class="header-buttons">
                        <div class="game-info">
                            <span>ğŸ”‘ ${gameCode}</span>
                            <span>ğŸ“Š ${gameData.round || 0}</span>
                        </div>
                        <button class="exit-btn" onclick="window.leaveGame()">ğŸšª Ø®Ø±ÙˆØ¬</button>
                    </div>
                </div>
            `;

            // Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†
            let playersList = '<div class="players-list">';
            for (let id in players) {
                const player = players[id];
                const lastSeen = player.lastSeen || 0;
                const now = Date.now();
                const isDisconnected = now - lastSeen > 30000; // 30 Ø«Ø§Ù†ÙŠØ© Ø¨Ø¯ÙˆÙ† ØªØ­Ø¯ÙŠØ«
                
                playersList += `
                    <div class="player-card ${player.isHost ? 'host' : ''}">
                        <div class="player-name">${player.name}</div>
                        <div class="score">${player.score || 0} Ù†Ù‚Ø·Ø©</div>
                        ${id === playerId ? '<span class="you-badge">Ø£Ù†Øª</span>' : ''}
                        ${isDisconnected ? '<span class="disconnected-badge">ØºÙŠØ± Ù…ØªØµÙ„</span>' : ''}
                    </div>
                `;
            }
            playersList += '</div>';

            // Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø­Ø³Ø¨ Ø­Ø§Ù„Ø© Ø§Ù„Ù„Ø¹Ø¨Ø©
            let gameContent = '';

            switch(gameData.status) {
                case 'waiting':
                    gameContent = renderWaitingScreen(playersCount, isHost);
                    break;
                case 'playing':
                    gameContent = renderPlayingScreen();
                    break;
                case 'answers':
                case 'voting':
                    gameContent = renderAnswersScreen();
                    break;
                case 'result':
                    gameContent = renderResultScreen();
                    break;
                default:
                    gameContent = '<div>Ø­Ø§Ù„Ø© ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙØ©</div>';
            }

            container.innerHTML = header + playersList + gameContent;
        }

        // Ø´Ø§Ø´Ø© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±
        function renderWaitingScreen(playersCount, isHost) {
            let content = `
                <div class="screen active">
                    <h2 style="text-align: center; margin: 20px 0;">â³ ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø¢Ø®Ø±ÙŠÙ†...</h2>
                    <p style="text-align: center; font-size: 1.2em;">Ø§Ù„Ù„Ø§Ø¹Ø¨ÙˆÙ†: ${playersCount}/5</p>
            `;

            if (isHost && playersCount >= 3) {
                content += `<button onclick="window.startGame()" style="width: auto; margin: 20px auto; display: block; padding: 15px 40px;">ğŸš€ Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨Ø©!</button>`;
            }

            // Ø±Ø§Ø¨Ø· Ø§Ù„Ø¯Ø¹ÙˆØ©
            const gameLink = window.location.href.split('?')[0] + `?join=${gameCode}`;
            content += `
                <div style="margin-top: 30px;">
                    <p style="margin-bottom: 10px;">ğŸ”— Ø±Ø§Ø¨Ø· Ø§Ù„Ø¯Ø¹ÙˆØ©:</p>
                    <div class="link-box">
                        <input type="text" value="${gameLink}" readonly id="gameLink">
                        <button class="copy-btn" onclick="copyGameLink()">Ù†Ø³Ø®</button>
                    </div>
                </div>
            `;

            content += '</div>';
            return content;
        }

        // Ø´Ø§Ø´Ø© Ø§Ù„ÙƒØªØ§Ø¨Ø©
        function renderPlayingScreen() {
            const isImposter = playerId === gameData.imposterId;
            const question = isImposter ? gameData.imposterQuestion : gameData.currentQuestion;
            const answersCount = Object.keys(gameData.answers || {}).length;
            const totalPlayers = Object.keys(gameData.players).length;
            const hasAnswered = gameData.answers?.[playerId] ? true : false;

            return `
                <div class="screen active">
                    <div class="question-box">
                        <h3>${isImposter ? 'ğŸ•µï¸ Ø£Ù†Øª Ø¨Ø±Ø§ Ø§Ù„Ø³Ø§Ù„ÙØ©!' : 'â“ Ø§Ù„Ø³Ø¤Ø§Ù„:'}</h3>
                        <p>${question || '...'}</p>
                    </div>
                    
                    <div class="answer-input">
                        <input type="text" id="answerInput" placeholder="Ø§ÙƒØªØ¨ Ø¥Ø¬Ø§Ø¨ØªÙƒ Ù‡Ù†Ø§..." maxlength="50" ${hasAnswered ? 'disabled' : ''}>
                        <button onclick="window.submitAnswer()" ${hasAnswered ? 'disabled' : ''}>
                            ${hasAnswered ? 'ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„' : 'Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©'}
                        </button>
                    </div>
                    
                    <div class="answers-status">
                        <p>ØªÙ…Øª Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©: ${answersCount}/${totalPlayers}</p>
                    </div>
                </div>
            `;
        }

        // Ø´Ø§Ø´Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª ÙˆØ§Ù„ØªØµÙˆÙŠØª
        function renderAnswersScreen() {
            let answers = '';
            for (let id in gameData.answers) {
                const player = gameData.players[id];
                const answer = gameData.answers[id];
                answers += `
                    <div class="answer-card">
                        <div class="player-name">${player.name}</div>
                        <div class="answer-text">"${answer}"</div>
                    </div>
                `;
            }

            let votingSection = '';
            if (gameData.status === 'voting') {
                let votingButtons = '';
                for (let id in gameData.players) {
                    if (id !== playerId) {
                        const player = gameData.players[id];
                        const hasVoted = gameData.votes?.[playerId] ? true : false;
                        votingButtons += `<button class="vote-btn" onclick="window.submitVote('${id}')" ${hasVoted ? 'disabled' : ''}>${player.name}</button>`;
                    }
                }

                votingSection = `
                    <div class="voting-section">
                        <h3>âš ï¸ Ù…Ù† Ù‡Ùˆ Ø¨Ø±Ø§ Ø§Ù„Ø³Ø§Ù„ÙØ©ØŸ</h3>
                        <div id="votingTimer">5</div>
                        <div id="votingButtons">
                            ${votingButtons || '<p>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù„Ø§Ø¹Ø¨ÙŠÙ† Ù„Ù„ØªØµÙˆÙŠØª Ø¹Ù„ÙŠÙ‡Ù…</p>'}
                        </div>
                    </div>
                `;
            }

            return `
                <div class="screen active">
                    <div class="reveal-section">
                        <button id="revealQuestionBtn" onclick="window.revealQuestion()" ${gameData.status !== 'answers' ? 'disabled' : ''}>
                            ğŸ” ÙƒØ´Ù Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ
                        </button>
                    </div>
                    
                    <div class="answers-display">
                        ${answers || '<p style="text-align: center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø¬Ø§Ø¨Ø§Øª Ø¨Ø¹Ø¯</p>'}
                    </div>
                    
                    ${votingSection}
                </div>
            `;
        }

        // Ø´Ø§Ø´Ø© Ø§Ù„Ù†ØªÙŠØ¬Ø©
        function renderResultScreen() {
            const lastResult = gameData.lastResult;
            if (!lastResult) return '<div>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</div>';

            const imposter = gameData.players[lastResult.imposterId];
            let resultContent = '';

            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙÙˆØ²
            let winner = null;
            for (let id in gameData.players) {
                if (gameData.players[id].score >= 5) {
                    winner = gameData.players[id];
                    break;
                }
            }

            if (winner) {
                resultContent = `
                    <div class="game-winner">
                        <h2>ğŸ† Ø§Ù„ÙØ§Ø¦Ø² Ù‡Ùˆ ${winner.name} ğŸ†</h2>
                        <p>ÙˆØµÙ„ Ø¥Ù„Ù‰ 5 Ù†Ù‚Ø§Ø· ÙˆØ§Ù†ØªÙ‡Øª Ø§Ù„Ù„Ø¹Ø¨Ø©!</p>
                    </div>
                `;
            } else {
                resultContent = `
                    <div class="result-content">
                        <div class="imposter-reveal">
                            <h3>ğŸ•µï¸ Ø¨Ø±Ø§ Ø§Ù„Ø³Ø§Ù„ÙØ© ÙƒØ§Ù†: ${imposter.name}</h3>
                            <p>Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ø®Ø§Øµ Ø¨Ù‡: ${gameData.imposterQuestion}</p>
                        </div>
                        
                        <div class="${lastResult.caught ? 'winner-reveal' : 'imposter-reveal'}">
                            ${lastResult.caught 
                                ? '<h3>âœ… ØªÙ… ÙƒØ´ÙÙ‡! Ø§Ù„Ø°ÙŠÙ† ØµÙˆØªÙˆØ§ Ø¹Ù„ÙŠÙ‡ Ø±Ø¨Ø­ÙˆØ§ Ù†Ù‚Ø·Ø©</h3>' 
                                : '<h3>ğŸ† Ø§Ù„Ø§Ù…Ø¨ÙˆØ³ØªØ± ÙƒØ³Ø¨! Ø±Ø¨Ø­ Ù†Ù‚Ø·Ø©</h3>'}
                        </div>
                    </div>
                `;
            }

            return `
                <div class="screen active">
                    ${resultContent}
                    <button id="nextRoundBtn" onclick="window.nextRound()">
                        ${winner ? 'Ù„Ø¹Ø¨Ø© Ø¬Ø¯ÙŠØ¯Ø©' : 'Ø§Ù„Ø¯ÙˆØ± Ø§Ù„ØªØ§Ù„ÙŠ'}
                    </button>
                </div>
            `;
        }

        // Ø¯ÙˆØ§Ù„ Ø§Ù„Ù„Ø¹Ø¨Ø© Ø§Ù„Ø¹Ø§Ù…Ø©
        window.createGame = async function() {
            const nameInput = document.getElementById('playerName');
            if (!nameInput?.value.trim()) {
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù…Ùƒ');
                return;
            }

            playerName = nameInput.value.trim();
            gameCode = Math.floor(1000 + Math.random() * 9000).toString();
            playerId = 'player1';

            try {
                // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØºØ±ÙØ©
                const gameRef = ref(database, 'games/' + gameCode);
                await set(gameRef, {
                    players: {
                        player1: {
                            name: playerName,
                            score: 0,
                            isHost: true,
                            lastSeen: Date.now()
                        }
                    },
                    status: 'waiting',
                    currentQuestion: null,
                    imposterQuestion: null,
                    answers: {},
                    votes: {},
                    imposterId: null,
                    round: 0,
                    createdAt: Date.now()
                });

                // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                saveGameData();
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
                renderApp();
                
            } catch (error) {
                console.error('Error creating game:', error);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØºØ±ÙØ©: ' + error.message);
            }
        };

        window.joinGame = async function() {
            const nameInput = document.getElementById('playerName');
            const codeInput = document.getElementById('gameCode');
            
            if (!nameInput?.value.trim() || !codeInput?.value.trim()) {
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù… ÙˆÙƒÙˆØ¯ Ø§Ù„ØºØ±ÙØ©');
                return;
            }

            playerName = nameInput.value.trim();
            gameCode = codeInput.value.trim();

            try {
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„ØºØ±ÙØ©
                const gameRef = ref(database, 'games/' + gameCode);
                const snapshot = await get(gameRef);
                
                if (!snapshot.exists()) {
                    alert('Ù‡Ø°Ù‡ Ø§Ù„ØºØ±ÙØ© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©');
                    return;
                }

                const gameData = snapshot.val();
                
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø§Ø³Ù… Ù…ÙƒØ±Ø±
                let nameExists = false;
                for (let id in gameData.players) {
                    if (gameData.players[id].name.toLowerCase() === playerName.toLowerCase()) {
                        nameExists = true;
                        break;
                    }
                }

                if (nameExists) {
                    alert('Ù‡Ø°Ø§ Ø§Ù„Ø§Ø³Ù… Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹ØŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ø³Ù… Ø¢Ø®Ø±');
                    return;
                }

                const playersCount = Object.keys(gameData.players || {}).length;
                const newPlayerId = 'player' + (playersCount + 1);
                playerId = newPlayerId;

                // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù„Ø§Ø¹Ø¨
                const updates = {};
                updates[`games/${gameCode}/players/${newPlayerId}`] = {
                    name: playerName,
                    score: 0,
                    isHost: false,
                    lastSeen: Date.now()
                };

                await update(ref(database), updates);

                // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                saveGameData();
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
                renderApp();
                
            } catch (error) {
                console.error('Error joining game:', error);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„Ø¹Ø¨Ø©: ' + error.message);
            }
        };

        window.startGame = function() {
            if (!gameData) return;
            
            const players = Object.keys(gameData.players);
            
            // Ø§Ø®ØªÙŠØ§Ø± Ø§Ù…Ø¨ÙˆØ³ØªØ± Ø¹Ø´ÙˆØ§Ø¦ÙŠ
            const nonHostPlayers = players.filter(p => !gameData.players[p].isHost);
            const imposterId = nonHostPlayers[Math.floor(Math.random() * nonHostPlayers.length)] || players[1];

            // Ø£Ø³Ø¦Ù„Ø© Ù…Ù‚ØªØ±Ø­Ø©
            const questions = [
                { normal: "Ø£ÙƒØ«Ø± Ø¨Ù„Ø¯ ØªØ­Ø¨ ØªØ²ÙˆØ±Ù‡ØŸ", imposter: "Ø£ÙƒØ«Ø± Ø¨Ù„Ø¯ ØªÙƒØ±Ù‡Ù‡ØŸ" },
                { normal: "Ø£ÙØ¶Ù„ ÙÙŠÙ„Ù… Ø´Ø§Ù‡Ø¯ØªÙ‡ØŸ", imposter: "Ø£Ø³ÙˆØ£ ÙÙŠÙ„Ù… Ø´Ø§Ù‡Ø¯ØªÙ‡ØŸ" },
                { normal: "Ø·Ø¹Ø§Ù…Ùƒ Ø§Ù„Ù…ÙØ¶Ù„ØŸ", imposter: "Ø·Ø¹Ø§Ù… ØªÙƒØ±Ù‡Ù‡ØŸ" },
                { normal: "Ù‡ÙˆØ§ÙŠØªÙƒ Ø§Ù„Ù…ÙØ¶Ù„Ø©ØŸ", imposter: "Ù†Ø´Ø§Ø· ØªÙƒØ±Ù‡ Ø¹Ù…Ù„Ù‡ØŸ" },
                { normal: "Ø­ÙŠÙˆØ§Ù†Ùƒ Ø§Ù„Ù…ÙØ¶Ù„ØŸ", imposter: "Ø­ÙŠÙˆØ§Ù† ØªØ®Ø§Ù Ù…Ù†Ù‡ØŸ" },
                { normal: "Ù„ÙˆÙ†Ùƒ Ø§Ù„Ù…ÙØ¶Ù„ØŸ", imposter: "Ù„ÙˆÙ† ØªÙƒØ±Ù‡Ù‡ØŸ" },
                { normal: "Ø±ÙŠØ§Ø¶ØªÙƒ Ø§Ù„Ù…ÙØ¶Ù„Ø©ØŸ", imposter: "Ø±ÙŠØ§Ø¶Ø© ØªÙƒØ±Ù‡ Ù…Ø´Ø§Ù‡Ø¯ØªÙ‡Ø§ØŸ" },
                { normal: "ÙÙ†Ø§Ù†Ùƒ Ø§Ù„Ù…ÙØ¶Ù„ØŸ", imposter: "ÙÙ†Ø§Ù† Ù„Ø§ ØªØ­Ø¨Ù‡ØŸ" }
            ];

            const selectedQuestion = questions[Math.floor(Math.random() * questions.length)];

            // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù„Ø¹Ø¨Ø©
            const updates = {};
            updates[`games/${gameCode}/status`] = 'playing';
            updates[`games/${gameCode}/currentQuestion`] = selectedQuestion.normal;
            updates[`games/${gameCode}/imposterQuestion`] = selectedQuestion.imposter;
            updates[`games/${gameCode}/imposterId`] = imposterId;
            updates[`games/${gameCode}/answers`] = {};
            updates[`games/${gameCode}/votes`] = {};
            updates[`games/${gameCode}/round`] = (gameData.round || 0) + 1;

            update(ref(database), updates).catch(error => {
                console.error('Error starting game:', error);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©');
            });
        };

        window.submitAnswer = function() {
            const answer = document.getElementById('answerInput')?.value.trim();
            if (!answer) {
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ ÙƒØªØ§Ø¨Ø© Ø¥Ø¬Ø§Ø¨Ø©');
                return;
            }

            const updates = {};
            updates[`games/${gameCode}/answers/${playerId}`] = answer;

            update(ref(database), updates).then(() => {
                const input = document.getElementById('answerInput');
                if (input) input.value = '';
            }).catch(error => {
                console.error('Error submitting answer:', error);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©');
            });
        };

        window.revealQuestion = function() {
            const updates = {};
            updates[`games/${gameCode}/status`] = 'voting';
            update(ref(database), updates).catch(error => {
                console.error('Error revealing question:', error);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ÙƒØ´Ù Ø§Ù„Ø³Ø¤Ø§Ù„');
            });
        };

        window.submitVote = function(votedId) {
            const updates = {};
            updates[`games/${gameCode}/votes/${playerId}`] = votedId;
            update(ref(database), updates).catch(error => {
                console.error('Error submitting vote:', error);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªØµÙˆÙŠØª');
            });
        };

        function startVotingTimer() {
            if (timerInterval) clearInterval(timerInterval);
            
            let timeLeft = 5;
            const timerElement = document.getElementById('votingTimer');
            if (timerElement) timerElement.textContent = timeLeft;

            timerInterval = setInterval(() => {
                timeLeft--;
                const timerEl = document.getElementById('votingTimer');
                if (timerEl) timerEl.textContent = timeLeft;

                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    endVoting();
                }
            }, 1000);
        }

        function endVoting() {
            if (!gameData) return;
            
            const votes = gameData.votes || {};
            const imposterId = gameData.imposterId;

            // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø£ØµÙˆØ§Øª
            let votesForImposter = 0;
            for (let voterId in votes) {
                if (votes[voterId] === imposterId) {
                    votesForImposter++;
                }
            }

            const playersCount = Object.keys(gameData.players).length;
            const imposterCaught = votesForImposter > (playersCount - votesForImposter);

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ù‚Ø§Ø·
            const updates = {};

            if (imposterCaught) {
                // Ø§Ù„Ø§Ù…Ø¨ÙˆØ³ØªØ± Ø§Ù†ÙƒØ´Ù
                for (let voterId in votes) {
                    if (votes[voterId] === imposterId) {
                        const currentScore = gameData.players[voterId]?.score || 0;
                        updates[`games/${gameCode}/players/${voterId}/score`] = currentScore + 1;
                    }
                }
                const imposterScore = gameData.players[imposterId]?.score || 0;
                updates[`games/${gameCode}/players/${imposterId}/score`] = Math.max(0, imposterScore - 1);
            } else {
                const imposterScore = gameData.players[imposterId]?.score || 0;
                updates[`games/${gameCode}/players/${imposterId}/score`] = imposterScore + 1;
            }

            updates[`games/${gameCode}/status`] = 'result';
            updates[`games/${gameCode}/lastResult`] = {
                imposterId: imposterId,
                caught: imposterCaught,
                votes: votes
            };

            update(ref(database), updates).catch(error => {
                console.error('Error ending voting:', error);
            });
        }

        window.nextRound = function() {
            if (!gameData) return;
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ ÙØ§Ø¦Ø²
            for (let id in gameData.players) {
                if (gameData.players[id].score >= 5) {
                    // Ø¨Ø¯Ø¡ Ù„Ø¹Ø¨Ø© Ø¬Ø¯ÙŠØ¯Ø©
                    const updates = {};
                    for (let playerId in gameData.players) {
                        updates[`games/${gameCode}/players/${playerId}/score`] = 0;
                    }
                    updates[`games/${gameCode}/status`] = 'waiting';
                    updates[`games/${gameCode}/round`] = 0;
                    updates[`games/${gameCode}/answers`] = {};
                    updates[`games/${gameCode}/votes`] = {};
                    update(ref(database), updates);
                    return;
                }
            }

            // Ø¬ÙˆÙ„Ø© Ø¬Ø¯ÙŠØ¯Ø©
            window.startGame();
        };

        window.copyGameLink = function() {
            const linkInput = document.getElementById('gameLink');
            if (linkInput) {
                linkInput.select();
                navigator.clipboard.writeText(linkInput.value);
                alert('âœ… ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·!');
            }
        };

        window.clearGameData = clearGameData;

        // Ø¨Ø¯Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
        renderApp();

        // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…Ø¤Ù‚ØªØ§Øª Ø¹Ù†Ø¯ Ø§Ù„Ø®Ø±ÙˆØ¬
        window.addEventListener('beforeunload', () => {
            if (timerInterval) clearInterval(timerInterval);
            if (presenceInterval) clearInterval(presenceInterval);
        });

        // ÙƒØ´Ù Ø¥Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù‚ÙÙ„ Ø§Ù„ØµÙØ­Ø©
        window.addEventListener('unload', async () => {
            if (gameCode && playerId) {
                // ØªØ­Ø¯ÙŠØ« Ø¢Ø®Ø± Ø¸Ù‡ÙˆØ± Ù‚Ø¨Ù„ Ø§Ù„Ø®Ø±ÙˆØ¬
                try {
                    const lastSeenRef = ref(database, `games/${gameCode}/players/${playerId}/lastSeen`);
                    await set(lastSeenRef, Date.now() - 60000); // Ø§Ø¬Ø¹Ù„Ù‡ ÙŠØ¸Ù‡Ø± ÙƒÙ…Ù†Ù‚Ø·Ø¹
                } catch (e) {
                    console.log('Error updating last seen on unload');
                }
            }
        });
    </script>
</body>
</html>